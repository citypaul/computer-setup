- name: Install and Configure Fabric
  tags:
    - install
    - ai
  block:
    - name: Install Go using Homebrew
      homebrew:
        name: go
        state: present

    - name: Create Fabric configuration directory
      file:
        path: "{{ fabric_config_dir }}"
        state: directory
        mode: "0755"

    - name: Create settings.yaml file with API keys
      copy:
        dest: "{{ fabric_config_dir }}/settings.yaml"
        content: |
          anthropic_api_key: "{{ anthropic_api_key }}"
        mode: "0600"

    - name: Check if Fabric is installed
      command: "which fabric"
      register: fabric_check
      failed_when: false
      changed_when: false

    - name: Install Fabric
      command: "go install github.com/danielmiessler/fabric@{{ fabric_version }}"
      environment:
        GOPATH: "{{ ansible_env.HOME }}/go"
        PATH: "{{ ansible_env.PATH }}:/usr/local/go/bin:{{ ansible_env.HOME }}/go/bin"
      when: fabric_check.rc != 0

    - name: Run Fabric setup (non-interactive)
      command: "{{ ansible_env.HOME }}/go/bin/fabric --setup --non-interactive"
      environment:
        GOPATH: "{{ ansible_env.HOME }}/go"
        PATH: "{{ ansible_env.PATH }}:/usr/local/go/bin:{{ ansible_env.HOME }}/go/bin"
      register: fabric_setup
      changed_when: fabric_setup.rc == 0
      failed_when: fabric_setup.rc != 0 and "already set up" not in fabric_setup.stderr

    - name: Set Go environment variables
      lineinfile:
        path: "{{ ansible_env.HOME }}/.zshrc"
        line: "{{ item }}"
        create: yes
      loop:
        - 'export GOPATH="{{ ansible_env.HOME }}/go"'
        - 'export PATH="/usr/local/go/bin:$GOPATH/bin:$PATH"'

    - name: Ensure ~/.config/fabric directory exists
      ansible.builtin.file:
        path: "{{ ansible_env.HOME }}/.config/fabric"
        state: directory
        mode: "0755"
      tags:
        - install
        - ai-tools
        - fabric

    - name: Copy Fabric AI .env file
      ansible.builtin.template:
        src: "../templates/fabric/.env"
        dest: "{{ ansible_env.HOME }}/.config/fabric/.env"
        mode: "0600"
      tags:
        - install
        - ai-tools
        - fabric

    - name: Copy Fabric settings.yaml file
      ansible.builtin.template:
        src: "../templates/fabric/settings.yaml"
        dest: "{{ fabric_config_dir }}/settings.yaml"
        mode: "0600"
      tags:
        - install
        - ai-tools
        - fabric

    - name: Check if yt helper is installed
      command: "which yt"
      register: yt_check
      changed_when: false
      failed_when: false

    - name: Install yt helper
      command: "go install github.com/danielmiessler/yt@latest"
      environment:
        GOPATH: "{{ ansible_env.HOME }}/go"
        PATH: "{{ ansible_env.PATH }}:/usr/local/go/bin:{{ ansible_env.HOME }}/go/bin"
      when: yt_check.rc != 0

    - name: Update fabric patterns
      command: "fabric -U"
      environment:
        GOPATH: "{{ ansible_env.HOME }}/go"
        PATH: "{{ ansible_env.PATH }}:/usr/local/go/bin:{{ ansible_env.HOME }}/go/bin"
